services:
    sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        container_name: sqlserver
        environment:
            SA_PASSWORD: "AS@admin"
            ACCEPT_EULA: "Y"
            MSSQL_PID: "Developer"
        ports:
            - "1433:1433"
        healthcheck:
            test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'AS@admin' -C -Q 'SELECT 1' || exit 1"]
            interval: 10s
            timeout: 5s
            retries: 5
    as.users.api:
        container_name: as.users.api
        image: ${DOCKER_REGISTRY-}asusersapi
        build:
            context: .
            dockerfile: AS.Users.API/Dockerfile
        depends_on:
            sqlserver:
                condition: service_healthy
        environment:
            ASPNETCORE_ENVIRONMENT: Development
            ConnectionStrings__DefaultConnection: "Server=sqlserver;Database=ASUsersDB;User Id=sa;Password=AS@admin;TrustServerCertificate=true"
        restart: on-failure
    prometheus:
        container_name: prometheus
        image: prom/prometheus:latest
        volumes:
            - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
        ports:
            - "9090:9090"
        depends_on: 
            - as.users.api
        restart: unless-stopped
    grafana:
        container_name: grafana
        image: grafana/grafana:latest
        environment:
            GF_SECURITY_ADMIN_PASSWORD: "admin"
        ports:
            - "3000:3000"
        volumes:
            - grafana-storage:/var/lib/grafana
        depends_on: 
            - prometheus
        restart: unless-stopped

volumes:
    grafana-storage:    